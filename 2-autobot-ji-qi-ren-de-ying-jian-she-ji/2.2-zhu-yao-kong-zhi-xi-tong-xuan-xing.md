# 2.2 主要控制系统选型

## 2.2.1 上位机主控选型

上位机作为机器人的大脑，承担机器人最复杂的计算任务，如建图、导航、人体姿态估计等。所以对上位机型号的选择尤为重要，它决定能否自如的完成机器人的计算任务。另外，在机器人设计时不仅要考虑当前功能的需要，还要留有一定计算冗余，便于后期增强神经网络算法深度，用于实现更复杂的功能。常用上位机主控有树莓派、JetsonNano、JetsonTX2、miniPC等，下表选择了其中具有代表性的几款产品进行对比：

| CPU  | 1.5GHz四核64位ARM Cortex-A72 CPU   | HMP Dual Denver 2/2 MB L2 +Quad ARM® A57/2 MB L2 | 四核 ARM Cortex A57               | <p>2.3GHz 四核Intel-i5 CPU<br>最大睿频频率：3.2GHz<br>缓存：6MB Intel Smart Cache<br>散热设计功耗（TDP）：45W</p> |
| ---- | ------------------------------- | ------------------------------------------------ | ------------------------------- | -------------------------------------------------------------------------------------------- |
| GPU  | Broadcom VeoCore IV@500MHz      | NVIA Pascal™，256 CUDA 核心                         | 128 Maxwell cores               | NviaN16P-GX(GTX960M), VRAM 4G GDDR5                                                          |
| 内存   | 2GB/4GB/8GB 可选                  | 8GB 128bit LPDDR4                                | 4GB 64bit LPDDR4                | 8GB DDR4-2133                                                                                |
| USB  | <p>2 x USB2.0<br>2 x USB3.0</p> | <p>1 x USB2.0<br>1 x USB3.0</p>                  | <p>1 x USB2.0<br>4 x USB3.0</p> | <p>2 x USB2.0<br>2 x USB3.0</p>                                                              |
| WiFi | 802.11b/g/n/ac 2.4GHz/5GHz双频    | 802.11 2x2 ac/BT Ready                           | M.2 Key E扩展WiFi                 | 802.11bgn                                                                                    |
| 功耗   | 15W                             | ≤7.5W                                            | 5-10W                           | 65W(UMA model) 120W (Nvia GPU model)                                                         |



如上表所述，树莓派虽功耗较低，但其整体性能有限，对于同时部署SLAM算法与人体姿态估计的神经网络算法来说，略显不足。Jetson系列是NVIA公司推出的嵌入式人工智能超级计算平台，在思科的电视电话会议系统、法拉赫的工厂自动化等都采用了Jetson系列计算平台。JetsonNano的四核A57CPU性能较为一般，与JetsonTX2的Denver核心要差不少。JetsonTX2的CPU相较于Intel Core系列的I5-3XXXU计算性能大致相当，所以相较于i5-6300HQ的miniPC还要差一些。

本人在使用JetsonTX2时，ARM架构下的部分功能包与工具稍有不足。在计算平台使用神经网络进行实验时，会用到较多不同深度学习框架，如Tensorflow、Pytorch等，其对系统环境的依赖有严格的要求，所以我们在实验时会使用Anaconda创建多个不同虚拟环境，用于支撑不同算法的运行。但Anaconda并不支持ARM架构，有着类似功能的miniconda、Archiconda等对程序功能包的支持却不如Anaconda。所以在实际使用中，Intel i5的miniPC更为便利。

所以考虑主控性能与实际使用，miniPC应为首选。但其额外突出的功耗却是十分值得考虑的问题。对于普通的实验平台，整体框架较小，驱动能力与承载能力有限，所以更加青睐高性能低功耗的计算平台。但本机器人的设计为实用平台，而非实验平台，其驱动能力与承载能力足以支撑miniPC的功耗。

综上所述，本机器人的主控型号选择，确定为搭载GTX960M的Intel-i5-6300HQ miniPC。

## 2.2.2 下位机主控选型

下位机主要用于控制电机、读取传感器数据、与上位机通讯等功能。由于SLAM算法中的导航算法大多基于概率模型，加上计算速率与传输速率的影响，仅仅依靠上位机很难实现实时性特别高的功能。尽管机器人设计的目标为低速移动机器人，出于安全考虑，机器人也要有多重安全防护措施。所以上位机SLAM算法的避障处理作为第一重防护，下位机直接读取的测距模块或雷达的距离信息作为第二重防护，为避免电信号受磁场、短路、断路等影响，在机器人机身布置防撞条作为机器人的第三重防护。所以下位机要尽量准确、快速的读取传感器信息，灵活、精准的实现通讯功能。

较为常用的下位机主控有STC51、MSP430、Arduino、STM32、飞思卡尔等。MSP430系列资料较少、飞思卡尔价格较高、STC51与Arduino的性能较STM32相差较多，ST公司推出的STM32CubeMX、CubeMonitor、X-CUBE-AI等为STM32的开发提供了极大便利。所以下位机主控确定在STM32单片机系列。

综合考虑前文说明的下位机主控要求，将主控型号的锁定在主流MCU和高性能MCU之间。下面选择两类中具有代表性的两款同配置单片机进行对比。

| Frequency(MHz) |     72    |    168    |
| :------------: | :-------: | :-------: |
|      Core      | Cortex-M3 | Cortex-M4 |
|       I2C      |     2     |     3     |
|       CAN      |     1     |     2     |
| USB OTG\_HS/FS |     0     |   1 + 1   |
|    Ethernet    |     0     |     1     |
|     U(S)ART    |   3 + 2   |   4 + 2   |

如上表所述，STM32F4系列主控频率更高，处理性能更强。我们常用的OLED、IMU等大多要用到I2C或USART通信，所以从通信接口看，STM32F4系列更胜一筹。STM32与ROS间使用串口通信时，需要借用USB-TTL电路实现，本人在魔方机器人的设计中使用USB-TTL模块通信时，常遇到信号不稳定与信号乱码情况，所以在本机器人的设计中使用VCP虚拟串口实现，这依赖于单片机的USB OTG\_HS/USB OTG\_FS。为使机器人配置更加灵活，机器人上位机与下位机还可使用Ethernet通信，所以选定STM32F4系列单片机。

在下位机的程序设计中，传感器数据读取、OLED显示、通讯、APP等互有交流，但运行互不影响，所以使用嵌入式操作系统将这几个功能分别置于不同线程运行，能更大效率利用单片机性能。使用实时操作系统依赖于较大FLASH。

综上，考虑运行性能、FLASH大小、读取传感器占用引脚等因素，选定LQFP100封装的STM32F407VGT6作为下位机主控。
